(in-package :colitrsynth)

(defun midino-to-freq (midino)
  (* 440.0
     (expt 2.0
           (/ (the fixnum (- midino 69))
              12.0))))

(define-compiler-macro midino-to-freq (&whole form midino)
  (if (constantp midino)
      (funcall 'midino-to-freq midino)
      form))

(defun midino-to-note (midino)
  (declare (optimize (speed 3) (safety 0))
           (fixnum midino))
  (case midino
    (0 'none)
    (-1 'off)

    (12 'c0 )
    (13 'c#0)
    (14 'd0 )
    (15 'd#0)
    (16 'e0 )
    (17 'f0 )
    (18 'f#0)
    (19 'g0 )
    (20 'g#0)
    (21 'a0 )
    (22 'a#0)
    (23 'b0 )

    (24 'c1 )
    (25 'c#1)
    (26 'd1 )
    (27 'd#1)
    (28 'e1 )
    (29 'f1 )
    (30 'f#1)
    (31 'g1 )
    (32 'g#1)
    (33 'a1 )
    (34 'a#1)
    (35 'b1 )

    (36 'c2 )
    (37 'c#2)
    (38 'd2 )
    (39 'd#2)
    (40 'e2 )
    (41 'f2 )
    (42 'f#2)
    (43 'g2 )
    (44 'g#2)
    (45 'a2 )
    (46 'a#2)
    (47 'b2 )

    (48 'c3 )
    (49 'c#3)
    (50 'd3 )
    (51 'd#3)
    (52 'e3 )
    (53 'f3 )
    (54 'f#3)
    (55 'g3 )
    (56 'g#3)
    (57 'a3 )
    (58 'a#3)
    (59 'b3 )

    (60 'c4 )
    (61 'c#4)
    (62 'd4 )
    (63 'd#4)
    (64 'e4 )
    (65 'f4 )
    (66 'f#4)
    (67 'g4 )
    (68 'g#4)
    (69 'a4 )
    (70 'a#4)
    (71 'b4 )

    (72 'c5 )
    (73 'c#5)
    (74 'd5 )
    (75 'd#5)
    (76 'e5 )
    (77 'f5 )
    (78 'f#5)
    (79 'g5 )
    (80 'g#5)
    (81 'a5 )
    (82 'a#5)
    (83 'b5 )

    (84 'c6 )
    (85 'c#6)
    (86 'd6 )
    (87 'd#6)
    (88 'e6 )
    (89 'f6 )
    (90 'f#6)
    (91 'g6 )
    (92 'g#6)
    (93 'a6 )
    (94 'a#6)
    (95 'b6 )

    (96 'c7 )
    (97 'c#7)
    (98 'd7 )
    (99 'd#7)
    (100 'e7 )
    (101 'f7 )
    (102 'f#7)
    (103 'g7 )
    (104 'g#7)
    (105 'a7 )
    (106 'a#7)
    (107 'b7 )

    (108 'c8 )
    (109 'c#8)
    (110 'd8 )
    (111 'd#8)
    (112 'e8 )
    (113 'f8 )
    (114 'f#8)
    (115 'g8 )
    (116 'g#8)
    (117 'a8 )
    (118 'a#8)
    (119 'b8 )

    (120 'c9 )
    (121 'c#9)
    (122 'd9 )
    (123 'd#9)
    (124 'e9 )
    (125 'f9 )
    (126 'f#9)
    (127 'g9 )
    (128 'g#9)
    (129 'a9 )
    (130 'a#9)
    (131 'b9 )))

(defconstant none 0)
(defconstant off -1)

(defconstant c0  12)
(defconstant c#0 13)
(defconstant d0  14)
(defconstant d#0 15)
(defconstant e0  16)
(defconstant f0  17)
(defconstant f#0 18)
(defconstant g0  19)
(defconstant g#0 20)
(defconstant a0  21)
(defconstant a#0 22)
(defconstant b0  23)

(defconstant c1  24)
(defconstant c#1 25)
(defconstant d1  26)
(defconstant d#1 27)
(defconstant e1  28)
(defconstant f1  29)
(defconstant f#1 30)
(defconstant g1  31)
(defconstant g#1 32)
(defconstant a1  33)
(defconstant a#1 34)
(defconstant b1  35)

(defconstant c2  36)
(defconstant c#2 37)
(defconstant d2  38)
(defconstant d#2 39)
(defconstant e2  40)
(defconstant f2  41)
(defconstant f#2 42)
(defconstant g2  43)
(defconstant g#2 44)
(defconstant a2  45)
(defconstant a#2 46)
(defconstant b2  47)

(defconstant c3  48)
(defconstant c#3 49)
(defconstant d3  50)
(defconstant d#3 51)
(defconstant e3  52)
(defconstant f3  53)
(defconstant f#3 54)
(defconstant g3  55)
(defconstant g#3 56)
(defconstant a3  57)
(defconstant a#3 58)
(defconstant b3  59)

(defconstant c4  60)
(defconstant c#4 61)
(defconstant d4  62)
(defconstant d#4 63)
(defconstant e4  64)
(defconstant f4  65)
(defconstant f#4 66)
(defconstant g4  67)
(defconstant g#4 68)
(defconstant a4  69)
(defconstant a#4 70)
(defconstant b4  71)

(defconstant c5  72)
(defconstant c#5 73)
(defconstant d5  74)
(defconstant d#5 75)
(defconstant e5  76)
(defconstant f5  77)
(defconstant f#5 78)
(defconstant g5  79)
(defconstant g#5 80)
(defconstant a5  81)
(defconstant a#5 82)
(defconstant b5  83)

(defconstant c6  84)
(defconstant c#6 85)
(defconstant d6  86)
(defconstant d#6 87)
(defconstant e6  88)
(defconstant f6  89)
(defconstant f#6 90)
(defconstant g6  91)
(defconstant g#6 92)
(defconstant a6  93)
(defconstant a#6 94)
(defconstant b6  95)

(defconstant c7  96)
(defconstant c#7 97)
(defconstant d7  98)
(defconstant d#7 99)
(defconstant e7  100)
(defconstant f7  101)
(defconstant f#7 102)
(defconstant g7  103)
(defconstant g#7 104)
(defconstant a7  105)
(defconstant a#7 106)
(defconstant b7  107)

(defconstant c8  108)
(defconstant c#8 109)
(defconstant d8  110)
(defconstant d#8 111)
(defconstant e8  112)
(defconstant f8  113)
(defconstant f#8 114)
(defconstant g8  115)
(defconstant g#8 116)
(defconstant a8  117)
(defconstant a#8 118)
(defconstant b8  119)

(defconstant c9  120)
(defconstant c#9 121)
(defconstant d9  122)
(defconstant d#9 123)
(defconstant e9  124)
(defconstant f9  125)
(defconstant f#9 126)
(defconstant g9  127)
(defconstant g#9 128)
(defconstant a9  129)
(defconstant a#9 130)
(defconstant b9  131)

(deftype midi-event-type () 'unsigned-byte)
(deftype midi-channel-type () 'unsigned-byte)
(deftype midi-note-type () 'unsigned-byte)
(deftype midi-velocity-type () 'unsigned-byte)

(defconstant +midi-event-on+ #x90)
(defconstant +midi-event-off+ #x80)
(defconstant +midi-cc+ #xB0)
(defconstant +midi-cc-all-notes-off+ #x7B)

(defclass midi-event ()
  ((event :initarg :event :initform +midi-event-on+ :accessor .event
          :type midi-event-type)
   (channel :initarg :channel :initform 1 :accessor .channel
            :type midi-channel-type)
   (note :initarg :note :initform c4 :accessor .note
         :type midi-note-type)
   (velocity :initarg :velocity :initform 100 :accessor .velocity
             :type midi-velocity-type)
   (frame :initarg :frame :initform 0 :accessor .frame
          :type fixnum)))

(defmethod print-object ((self midi-event) stream)
    (print-unreadable-object (self stream :type t)
      (format stream "~x ~a ~d ~d"
              (.event self)
              (midino-to-note (.note self))
              (.velocity self)
              (.frame self))))

(defun midi-event-all-notes-off ()
  (make-instance 'midi-event
                 :event +midi-cc+
                 :note +midi-cc-all-notes-off+))

;; TODO delete
;; (defun write-midi-event (midi-event stream)
;;   (write-byte (.event midi-event) stream)
;;   (write-byte (.channel midi-event) stream)
;;   (write-byte (.note midi-event) stream)
;;   (write-byte (.velocity midi-event) stream)
;;   (write-byte (.frame midi-event) stream))

#+nil
(flex:with-output-to-sequence (out)
 (write-midi-event (make-instance 'midi-event) out))

